<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Live Georgian National Bank currency rates for USD and EUR.">
  <title>USD & EUR Rates</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f9fafb;
      --surface: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      --accent: #3b82f6;
      --error: #b91c1c;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --surface: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --success: #4ade80;
        --danger: #f87171;
        --border: #374151;
        --shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
        --accent: #60a5fa;
        --error: #fca5a5;
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 1rem;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .card {
      width: min(100%, 360px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1rem;
      position: relative;
    }

    h1 {
      margin: 0 0 0.75rem;
      font-size: 1rem;
      font-weight: 700;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0.5rem;
    }

    th,
    td {
      padding: 0.5rem 0.25rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
      font-variant-numeric: tabular-nums;
    }

    tbody tr:last-child td {
      border-bottom: 0;
    }

    th {
      font-size: 0.75rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    .trend-same {
      color: var(--muted);
    }

    .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--muted);
      min-height: 1.25rem;
    }

    .error {
      color: var(--error);
    }

    .loading {
      width: 14px;
      height: 14px;
      border: 2px solid var(--muted);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    .loading[data-active="true"] {
      display: inline-block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <main class="card" aria-labelledby="title">
    <h1 id="title">NBG Exchange Rates</h1>

    <table aria-describedby="status">
      <thead>
        <tr>
          <th scope="col">Currency</th>
          <th scope="col">Rate</th>
          <th scope="col">Change</th>
        </tr>
      </thead>
      <tbody>
        <tr id="usd">
          <td>USD</td>
          <td data-role="rate">—</td>
          <td data-role="diff" class="trend-same">• —</td>
        </tr>
        <tr id="eur">
          <td>EUR</td>
          <td data-role="rate">—</td>
          <td data-role="diff" class="trend-same">• —</td>
        </tr>
      </tbody>
    </table>

    <div class="meta" id="status" aria-live="polite" aria-atomic="true">
      <span id="timestamp">Last update: never</span>
      <span id="error" class="error" role="status"></span>
      <span id="loading" class="loading" aria-hidden="true"></span>
      <span class="sr-only" id="live-region"></span>
    </div>
  </main>

  <script>
    (() => {
      'use strict';

      const CONFIG = Object.freeze({
        apiUrl: 'https://nbg.gov.ge/gw/api/ct/monetarypolicy/currencies/ka/json',
        proxyUrl: null,
        refreshMs: 5 * 60 * 1000,
        maxBackoffMs: 30 * 60 * 1000,
        requestTimeoutMs: 8000,
        trackedCodes: ['USD', 'EUR']
      });

      const state = {
        failures: 0,
        timerId: null,
        inFlightController: null
      };

      const dom = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        timestamp: document.getElementById('timestamp'),
        liveRegion: document.getElementById('live-region')
      };

      function toFiniteNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function setLoading(isLoading) {
        dom.loading.setAttribute('data-active', String(isLoading));
      }

      function setError(message) {
        dom.error.textContent = message;
      }

      function setTimestamp(date = new Date()) {
        dom.timestamp.textContent = `Last update: ${new Intl.DateTimeFormat(undefined, {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }).format(date)}`;
      }

      function renderRow(code, item) {
        const row = document.getElementById(code.toLowerCase());
        if (!row) return;

        const rateCell = row.querySelector('[data-role="rate"]');
        const diffCell = row.querySelector('[data-role="diff"]');
        if (!rateCell || !diffCell) return;

        const rate = toFiniteNumber(item?.rate);
        const diff = toFiniteNumber(item?.diff);

        rateCell.textContent = rate === null ? '—' : rate.toFixed(4);

        const trendClass = diff === null || diff === 0 ? 'trend-same' : diff > 0 ? 'trend-up' : 'trend-down';
        const trendSymbol = diff === null || diff === 0 ? '•' : diff > 0 ? '▲' : '▼';
        diffCell.className = trendClass;
        diffCell.textContent = `${trendSymbol} ${diff === null ? '—' : diff.toFixed(4)}`;
      }

      function normalizePayload(payload) {
        if (!Array.isArray(payload)) {
          throw new TypeError('Unexpected API payload shape: expected array.');
        }

        return payload.flatMap(entry => Array.isArray(entry?.currencies) ? entry.currencies : []);
      }

      async function fetchWithTimeout(url, timeoutMs, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        state.inFlightController = controller;

        try {
          const response = await fetch(url, {
            ...options,
            cache: 'no-cache',
            signal: controller.signal,
            headers: {
              Accept: 'application/json',
              ...(options.headers || {})
            }
          });
          return response;
        } finally {
          clearTimeout(timeoutId);
          state.inFlightController = null;
        }
      }

      async function fetchAndRender() {
        setLoading(true);
        setError('');
        const url = CONFIG.proxyUrl || CONFIG.apiUrl;

        try {
          const response = await fetchWithTimeout(url, CONFIG.requestTimeoutMs);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          const currencies = normalizePayload(data);
          const byCode = new Map(currencies.map(item => [String(item?.code || '').toUpperCase(), item]));

          for (const code of CONFIG.trackedCodes) {
            renderRow(code, byCode.get(code) || null);
          }

          setTimestamp();
          dom.liveRegion.textContent = 'Rates updated successfully.';
          state.failures = 0;
        } catch (error) {
          state.failures += 1;
          const message = error?.name === 'AbortError'
            ? 'Request timed out. Will retry automatically.'
            : 'Failed to load rates. Retrying automatically.';
          setError(message);
          dom.liveRegion.textContent = message;
          console.error('Rate fetch failed:', error);
        } finally {
          setLoading(false);
        }
      }

      function nextDelayMs() {
        const exponentialFactor = 2 ** Math.max(state.failures - 1, 0);
        return Math.min(CONFIG.refreshMs * exponentialFactor, CONFIG.maxBackoffMs);
      }

      async function scheduleLoop() {
        await fetchAndRender();
        const delay = nextDelayMs();
        state.timerId = window.setTimeout(scheduleLoop, delay);
      }

      window.addEventListener('beforeunload', () => {
        if (state.timerId !== null) {
          clearTimeout(state.timerId);
        }
        state.inFlightController?.abort();
      });

      scheduleLoop();
    })();
  </script>
</body>
</html>
