<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Live Georgian National Bank currency rates for USD and EUR.">
  <title>NBG Exchange Rates</title>
  <style>
    :root {
      --bg-0: #06090f;
      --bg-1: #0b1220;
      --surface: rgba(11, 18, 32, 0.92);
      --surface-2: rgba(15, 23, 42, 0.92);
      --text: #e5ecff;
      --muted: #9fb0d1;
      --line: #1f2c43;
      --line-2: #2a3a56;
      --accent: #7c8cff;
      --accent-soft: rgba(124, 140, 255, 0.18);
      --success: #58df90;
      --danger: #ff7d91;
      --error: #ff8da0;
      --shadow: 0 20px 44px rgba(0, 0, 0, 0.45);
      --radius: 16px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --cell-y: 8px;
      --cell-x: 12px;
      --font-body: 14px;
      --header-overlay: rgba(124, 140, 255, 0.18);
      --toggle-bg: rgba(8, 13, 24, 0.78);
      --thead-bg: rgba(10, 16, 29, 0.96);
      --sticky-bg: rgba(10, 16, 29, 0.96);
      --hover-ring: rgba(124, 140, 255, 0.12);
    }

    body[data-theme="dark"] {
      color-scheme: dark;
    }

    body[data-theme="light"] {
      color-scheme: light;
      --bg-0: #f2f6ff;
      --bg-1: #ffffff;
      --surface: rgba(255, 255, 255, 0.97);
      --surface-2: rgba(248, 250, 255, 0.96);
      --text: #17233c;
      --muted: #667da7;
      --line: #d3def4;
      --line-2: #becde8;
      --accent: #4f67ee;
      --accent-soft: rgba(79, 103, 238, 0.14);
      --success: #0d9d59;
      --danger: #cf3955;
      --error: #d53e5d;
      --shadow: 0 20px 38px rgba(35, 55, 103, 0.14);
      --header-overlay: rgba(79, 103, 238, 0.13);
      --toggle-bg: rgba(236, 242, 255, 0.95);
      --thead-bg: rgba(247, 250, 255, 0.97);
      --sticky-bg: rgba(250, 252, 255, 0.97);
      --hover-ring: rgba(79, 103, 238, 0.16);
    }

    [data-density="comfortable"] {
      --cell-y: 12px;
      --cell-x: 16px;
      --font-body: 15px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: Inter, "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1000px 500px at 50% -15%, rgba(124, 140, 255, 0.2), transparent 70%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-0) 100%);
      color: var(--text);
      padding: var(--space-4);
      font-size: var(--font-body);
    }

    .card {
      width: min(100%, 360px);
      background: linear-gradient(180deg, var(--surface), var(--surface-2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header {
      padding: var(--space-3) var(--space-3) var(--space-2);
      border-bottom: 1px solid var(--line);
      background: linear-gradient(130deg, var(--header-overlay), transparent 62%);
    }

    .title-row {
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: var(--space-2);
    }

    h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.01em;
      font-weight: 700;
      line-height: 1.3;
    }

    .subtitle {
      margin: var(--space-1) 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.3;
    }

    .density-toggle {
      display: inline-flex;
      border: 1px solid var(--line-2);
      border-radius: 999px;
      overflow: hidden;
      background: var(--toggle-bg);
      flex: 0 0 auto;
    }

    .controls {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .theme-toggle {
      appearance: none;
      border: 1px solid var(--line-2);
      border-radius: 999px;
      background: var(--toggle-bg);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 700;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      min-width: 74px;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: color-mix(in oklab, var(--accent-soft) 75%, var(--toggle-bg));
      transform: translateY(-1px);
    }

    .theme-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .theme-icon {
      font-size: 13px;
      line-height: 1;
    }

    .density-toggle button {
      appearance: none;
      border: 0;
      margin: 0;
      color: var(--muted);
      background: transparent;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .density-toggle button[aria-pressed="true"] {
      color: var(--text);
      background: var(--accent-soft);
    }

    .table-wrap {
      max-height: 172px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--line-2) transparent;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
    }

    th,
    td {
      padding: var(--cell-y) var(--cell-x);
      text-align: left;
      border-bottom: 1px solid var(--line);
      font-variant-numeric: tabular-nums;
      background: transparent;
    }

    th {
      position: sticky;
      top: 0;
      z-index: 3;
      color: var(--muted);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      background: var(--thead-bg);
      backdrop-filter: blur(6px);
    }

    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: var(--sticky-bg);
    }

    th:first-child {
      z-index: 4;
    }

    tbody tr {
      transition: transform 0.18s ease, background 0.18s ease, box-shadow 0.18s ease;
      transform-style: preserve-3d;
    }

    tbody tr:hover {
      background: color-mix(in oklab, var(--accent-soft) 55%, transparent);
      transform: translate3d(0, -1px, 0);
      box-shadow: inset 0 0 0 1px var(--hover-ring);
    }

    tbody tr:last-child td {
      border-bottom: 0;
    }

    td:first-child {
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    td[data-role="rate"],
    td[data-role="diff"] {
      white-space: nowrap;
    }

    td[data-role="rate"] {
      font-weight: 600;
    }

    td[data-role="diff"],
    th:last-child,
    td:last-child {
      text-align: right;
      font-weight: 600;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    .trend-same { color: var(--muted); }

    .meta {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3) var(--space-3);
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
    }

    #timestamp { overflow-wrap: anywhere; }

    .status-right {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 20px;
      justify-content: flex-end;
    }

    .error {
      color: var(--error);
      max-width: 176px;
      text-align: right;
    }

    .loading {
      width: 14px;
      height: 14px;
      border: 2px solid color-mix(in oklab, var(--muted) 60%, transparent);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.72s linear infinite;
      display: none;
      flex: 0 0 auto;
    }

    .loading[data-active="true"] { display: inline-block; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body data-density="compact">
  <main class="card" aria-labelledby="title">
    <header class="header">
      <div class="title-row">
        <div>
          <h1 id="title">NBG Exchange Rates</h1>
          <p class="subtitle" id="theme-subtitle">Live USD / EUR ¬∑ ·É¶·Éê·Éõ·Éî</p>
        </div>

        <div class="controls">
          <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Switch to light mode" aria-pressed="false">
            <span class="theme-icon" id="theme-icon" aria-hidden="true">üåô</span>
            <span id="theme-label">·É¶·Éê·Éõ·Éî</span>
          </button>

          <div class="density-toggle" role="group" aria-label="Table density">
            <button id="compact-btn" type="button" data-density="compact" aria-pressed="true">Compact</button>
            <button id="comfortable-btn" type="button" data-density="comfortable" aria-pressed="false">Comfort</button>
          </div>
        </div>
      </div>
    </header>

    <div class="table-wrap">
      <table aria-describedby="status">
        <thead>
          <tr>
            <th scope="col">Currency</th>
            <th scope="col">Rate</th>
            <th scope="col">Change</th>
          </tr>
        </thead>
        <tbody>
          <tr id="usd">
            <td>USD</td>
            <td data-role="rate">‚Äî</td>
            <td data-role="diff" class="trend-same">‚Ä¢ ‚Äî</td>
          </tr>
          <tr id="eur">
            <td>EUR</td>
            <td data-role="rate">‚Äî</td>
            <td data-role="diff" class="trend-same">‚Ä¢ ‚Äî</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="meta" id="status" aria-live="polite" aria-atomic="true">
      <span id="timestamp">Last update: never</span>
      <span class="status-right">
        <span id="error" class="error" role="status"></span>
        <span id="loading" class="loading" aria-hidden="true"></span>
      </span>
      <span class="sr-only" id="live-region"></span>
    </div>
  </main>

  <script>
    (() => {
      'use strict';

      const CONFIG = Object.freeze({
        apiUrl: 'https://nbg.gov.ge/gw/api/ct/monetarypolicy/currencies/ka/json',
        proxyUrl: null,
        refreshMs: 5 * 60 * 1000,
        maxBackoffMs: 30 * 60 * 1000,
        requestTimeoutMs: 8000,
        trackedCodes: ['USD', 'EUR']
      });

      const state = {
        failures: 0,
        timerId: null,
        inFlightController: null
      };

      const dom = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        timestamp: document.getElementById('timestamp'),
        liveRegion: document.getElementById('live-region'),
        subtitle: document.getElementById('theme-subtitle'),
        compactBtn: document.getElementById('compact-btn'),
        comfortableBtn: document.getElementById('comfortable-btn'),
        themeToggle: document.getElementById('theme-toggle'),
        themeIcon: document.getElementById('theme-icon'),
        themeLabel: document.getElementById('theme-label')
      };

      function toFiniteNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function setDensity(density) {
        const normalized = density === 'comfortable' ? 'comfortable' : 'compact';
        document.body.setAttribute('data-density', normalized);
        dom.compactBtn.setAttribute('aria-pressed', String(normalized === 'compact'));
        dom.comfortableBtn.setAttribute('aria-pressed', String(normalized === 'comfortable'));
      }

      function setTheme(theme) {
        const normalized = theme === 'light' ? 'light' : 'dark';
        const isLight = normalized === 'light';
        document.body.setAttribute('data-theme', normalized);
        dom.themeLabel.textContent = isLight ? '·Éì·É¶·Éî' : '·É¶·Éê·Éõ·Éî';
        dom.themeIcon.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        dom.subtitle.textContent = `Live USD / EUR ¬∑ ${isLight ? '·Éì·É¶·Éî' : '·É¶·Éê·Éõ·Éî'}`;
        dom.themeToggle.setAttribute('aria-pressed', String(isLight));
        dom.themeToggle.setAttribute('aria-label', isLight ? 'Switch to dark mode' : 'Switch to light mode');
      }

      function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
        setTheme(currentTheme === 'light' ? 'dark' : 'light');
      }

      function setLoading(isLoading) {
        dom.loading.setAttribute('data-active', String(isLoading));
      }

      function setError(message) {
        dom.error.textContent = message;
      }

      function setTimestamp(date = new Date()) {
        dom.timestamp.textContent = `Last update: ${new Intl.DateTimeFormat(undefined, {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }).format(date)}`;
      }

      function renderRow(code, item) {
        const row = document.getElementById(code.toLowerCase());
        if (!row) return;

        const rateCell = row.querySelector('[data-role="rate"]');
        const diffCell = row.querySelector('[data-role="diff"]');
        if (!rateCell || !diffCell) return;

        const rate = toFiniteNumber(item?.rate);
        const diff = toFiniteNumber(item?.diff);

        rateCell.textContent = rate === null ? '‚Äî' : rate.toFixed(4);

        const trendClass = diff === null || diff === 0 ? 'trend-same' : diff > 0 ? 'trend-up' : 'trend-down';
        const trendSymbol = diff === null || diff === 0 ? '‚Ä¢' : diff > 0 ? '‚ñ≤' : '‚ñº';
        diffCell.className = trendClass;
        diffCell.textContent = `${trendSymbol} ${diff === null ? '‚Äî' : diff.toFixed(4)}`;
      }

      function normalizePayload(payload) {
        if (!Array.isArray(payload)) {
          throw new TypeError('Unexpected API payload shape: expected array.');
        }

        return payload.flatMap(entry => Array.isArray(entry?.currencies) ? entry.currencies : []);
      }

      async function fetchRates(signal) {
        const endpoint = CONFIG.proxyUrl
          ? `${CONFIG.proxyUrl}${encodeURIComponent(CONFIG.apiUrl)}`
          : CONFIG.apiUrl;

        const timeoutController = new AbortController();
        const timeoutId = setTimeout(() => timeoutController.abort(), CONFIG.requestTimeoutMs);

        const linkedAbort = () => timeoutController.abort();
        signal?.addEventListener('abort', linkedAbort, { once: true });

        try {
          const response = await fetch(endpoint, {
            method: 'GET',
            headers: { Accept: 'application/json' },
            signal: timeoutController.signal,
            mode: 'cors',
            cache: 'no-store'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const payload = await response.json();
          return normalizePayload(payload);
        } finally {
          clearTimeout(timeoutId);
          signal?.removeEventListener('abort', linkedAbort);
        }
      }

      function scheduleNext(ms) {
        clearTimeout(state.timerId);
        state.timerId = setTimeout(refreshCycle, ms);
      }

      function nextBackoffDelay() {
        const delay = CONFIG.refreshMs * 2 ** Math.max(0, state.failures - 1);
        return Math.min(delay, CONFIG.maxBackoffMs);
      }

      async function refreshCycle() {
        state.inFlightController?.abort();
        state.inFlightController = new AbortController();
        setLoading(true);
        setError('');

        try {
          const currencies = await fetchRates(state.inFlightController.signal);

          for (const code of CONFIG.trackedCodes) {
            const item = currencies.find(currency => currency?.code === code);
            renderRow(code, item);
          }

          state.failures = 0;
          setTimestamp();
          dom.liveRegion.textContent = 'Exchange rates updated successfully.';
          scheduleNext(CONFIG.refreshMs);
        } catch (error) {
          if (error?.name === 'AbortError') {
            return;
          }

          state.failures += 1;
          const retryInMs = nextBackoffDelay();
          setError(`Update failed. Retrying in ${Math.round(retryInMs / 1000)}s.`);
          dom.liveRegion.textContent = 'Unable to refresh exchange rates. Retry scheduled.';
          scheduleNext(retryInMs);
        } finally {
          setLoading(false);
        }
      }

      dom.compactBtn.addEventListener('click', () => setDensity('compact'));
      dom.comfortableBtn.addEventListener('click', () => setDensity('comfortable'));
      dom.themeToggle.addEventListener('click', toggleTheme);
      setTheme('dark');
      setDensity('compact');
      refreshCycle();
    })();
  </script>
</body>
</html>
